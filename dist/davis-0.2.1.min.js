// davis.js JavaScript Routing, version: 0.2.1
// (c) 2011 Oliver Nightingale
//
//  Released under MIT license.
//
Davis=function(c){var d=new Davis.App;c.call(d);return d};Davis.supported=function(){return typeof window.history.pushState=="function"};
Davis.listener=function(){var c=function(b){return function(f){f=new Davis.Request(b.call($(f.target)));Davis.history.pushState(f);return false}},d=c(function(){return{method:"get",fullPath:this.attr("href"),title:this.attr("title")}}),a=c(function(){return{method:this.attr("method"),fullPath:[this.attr("action"),function(b){return b.serializeArray().map(function(f){return[f.name,f.value].join("=")}).join("&")}(this)].join("?"),title:this.attr("title")}});return{listen:function(){$(document).delegate(this.settings.formSelector,
"submit",a);$(document).delegate(this.settings.linkSelector,"click",d)},unlisten:function(){$(document).undelegate(this.settings.linkSelector,"click",d);$(document).undelegate(this.settings.formSelector,"submit",a)}}}();
Davis.event={_callbacks:{},bind:function(c,d){this._callbacks[c]||(this._callbacks[c]=[]);this._callbacks[c].push(d);return this},trigger:function(c){var d=this,a=arguments;this._callbacks[c]||(this._callbacks[c]=[]);this._callbacks[c].forEach(function(b){b.apply(d,Array.prototype.slice.call(a,1))});return this}};
Davis.logger=function(){var c=function(d){d=Array.prototype.slice.call(d);d.unshift("["+Date()+"]");return d};return{error:function(){window.console&&console.error.apply(console,c(arguments))},info:function(){window.console&&console.info.apply(console,c(arguments))},warn:function(){window.console&&console.warn.apply(console,c(arguments))}}}();
Davis.Route=function(){var c=/:([\w\d]+)/g,d=function(a,b,f){this.paramNames=function(){for(var g=[],h;h=c.exec(b);)g.push(h[1]);return g}();var e;e=b instanceof RegExp?b:RegExp("^"+b.replace(c,"([^/]+)")+"$","g");this.path=e;this.method=a instanceof RegExp?a:RegExp("^"+a+"$");this.callback=f};d.prototype={match:function(a,b){this.reset();return this.method.test(a)&&this.path.test(b)},reset:function(){this.method.lastIndex=0;this.path.lastIndex=0},run:function(a){this.reset();var b=this.path.exec(a.path);
if(b){b.shift();for(var f=0;f<b.length;f++)a.params[this.paramNames[f]]=b[f]}return this.callback.call(a,a)},toString:function(){return[this.method,this.path].join(" ")}};return d}();
Davis.router=function(){var c=this;["get","post","put"].forEach(function(d){c[d]=function(a,b){c._routeCollection.push(new Davis.Route(d,a,b))}});this.del=function(d,a){c._routeCollection.push(new Davis.Route("delete",d,a))};this.state=function(d,a){c._routeCollection.push(new Davis.Route("state",d,a))};this.trans=function(d,a){var b=a?[d,decodeURIComponent($.param(a))].join("?"):d;b=new Davis.Request({method:"state",fullPath:b,title:""});Davis.history.pushState(b)};["before","after"].forEach(function(d){c[d]=
function(){if(arguments.length==1)var b=/.+/,f=arguments[0];else if(arguments.length==2){b=arguments[0];f=arguments[1]}c._filterCollection[d].push(new Davis.Route(/.+/,b,f))};var a="lookup"+d.replace(/^\w/,function(b){return b.toUpperCase()})+"Filter";c[a]=function(b,f){return c._filterCollection[d].filter(function(e){return e.match(b,f)})}});c._routeCollection=[];c._filterCollection={before:[],after:[]};c.lookupRoute=function(d,a){return this._routeCollection.filter(function(b){return b.match(d,
a)})[0]}};Davis.history=function(){var c=[],d=function(a){return function(b){if(b.state){b=b.state;b.__proto__=Davis.Request.prototype;a(b)}else a(Davis.Request.forPageLoad())}};return{replaceState:function(a){history.replaceState(a,a.title,a.historyPath);c.forEach(function(b){b(a)})},pushState:function(a){history.pushState(a,a.title,a.location());c.forEach(function(b){b(a)})},onChange:function(a){c.push(a);a=d(a);window.addEventListener("popstate",a,true)}}}();
Davis.Request=function(c){var d=this;this.params={};this.title=c.title;this.queryString=c.fullPath.split("?")[1];this.type="request";this._staleCallback=function(){};this.queryString&&this.queryString.split("&").forEach(function(a){var b=a.split("=")[0];a=a.split("=")[1];var f;if(f=/^(\w+)\[(\w+)\]/.exec(b)){var e=f[1];b=f[2];f=d.params[e]||{};f[b]=a;d.params[e]=f}else d.params[b]=a});this.method=this.params._method||c.method;this.path=c.fullPath.replace(/\?.+$/,"");Davis.Request.prev&&Davis.Request.prev.makeStale(this);
Davis.Request.prev=this};Davis.Request.prototype.redirect=function(c){Davis.history.replaceState(new Davis.Request({method:"get",fullPath:c,title:this.title}))};Davis.Request.prototype.whenStale=function(c){this._staleCallback=c};Davis.Request.prototype.makeStale=function(c){this._staleCallback.call(c,c)};Davis.Request.prototype.location=function(){return this.method==="state"?"":this.path};Davis.Request.prototype.toString=function(){return[this.method.toUpperCase(),this.path].join(" ")};
Davis.Request.forPageLoad=function(){return new this({method:"get",fullPath:window.location.pathname,title:document.title})};Davis.Request.prev=null;
Davis.App=function(){var c=0,d=function(){this.id=[(new Date).valueOf(),c++].join("-");this.running=false};d.prototype=$.extend({configure:function(a){a.call(this.settings)},settings:{linkSelector:"a",formSelector:"form",logger:Davis.logger},start:function(){var a=this;if(Davis.supported()){var b=function(e){return function(g){g=g.run(e,e);return typeof g==="undefined"||g}},f=function(e){if(a.lookupBeforeFilter(e.method,e.path).every(b(e))){a.trigger("lookupRoute",e);var g=a.lookupRoute(e.method,
e.path);if(g){a.trigger("runRoute",e,g);g.run(e);a.lookupAfterFilter(e.method,e.path).every(b(e))}else a.trigger("routeNotFound",e)}else a.trigger("requestHalted",e)};Davis.history.onChange(function(e){f(e)});this.bind("runRoute",function(e){a.settings.logger.info("runRoute: "+e.toString())}).bind("routeNotFound",function(e){a.settings.logger.warn("routeNotFound: "+e.toString())}).bind("start",function(){a.settings.logger.info("application started")});this.listen();this.trigger("start");this.running=
true;f(Davis.Request.forPageLoad())}else this.trigger("unsupported")},stop:function(){this.unlisten();this.trigger("stop")}},Davis.listener,Davis.event);Davis.router.call(d.prototype);return d}();
