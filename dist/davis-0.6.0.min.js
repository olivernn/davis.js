// davis.js JavaScript Routing, version: 0.6.0
// (c) 2011 Oliver Nightingale
//
//  Released under MIT license.
//
Davis=function(a){var b=new Davis.App;a.call(b);return b};Davis.supported=function(){return typeof window.history.pushState=="function"};Davis.noop=function(){};Davis.extend=function(a){a(Davis)};
Davis.utils=function(){return{every:Array.prototype.every?function(a,b,c){return a.every(b,c)}:function(a,b,c){if(a===void 0||a===null)throw new TypeError;a=Object(a);var e=a.length>>>0;if(typeof b!=="function")throw new TypeError;for(var d=0;d<e;d++)if(d in a&&!b.call(c,a[d],d,a))return!1;return!0},forEach:Array.prototype.forEach?function(a,b,c){return a.forEach(b,c)}:function(a,b,c){if(a===void 0||a===null)throw new TypeError;a=Object(a);var e=a.length>>>0;if(typeof b!=="function")throw new TypeError;
for(var d=0;d<e;d++)d in a&&b.call(c,a[d],d,a)},filter:Array.prototype.filter?function(a,b,c){return a.filter(b,c)}:function(a,b,c){if(a===void 0||a===null)throw new TypeError;a=Object(a);var e=a.length>>>0;if(typeof b!=="function")throw new TypeError;for(var d=[],f=0;f<e;f++)if(f in a){var g=a[f];b.call(c,g,f,a)&&d.push(g)}return d},map:Array.prototype.map?function(a,b,c){return a.map(b,c)}:function(a,b,c){if(a===void 0||a===null)throw new TypeError;a=Object(a);var e=a.length>>>0;if(typeof b!=="function")throw new TypeError;
for(var d=Array(e),f=0;f<e;f++)f in a&&(d[f]=b.call(c,a[f],f,a));return d},toArray:function(a,b){return Array.prototype.slice.call(a,b||0)}}}();
Davis.listener=function(){var a={A:function(a){return a.host!==window.location.host},FORM:function(a){var c=document.createElement("a");c.href=a.action;return this.A(c)}},b=function(c){return function(){var b;b=a[this.nodeName]?a[this.nodeName](this):!0;if(b)return!0;b=new Davis.Request(c.call(jQuery(this)));Davis.location.assign(b);return!1}},c=b(function(){var a=this;return{method:"get",fullPath:this.attr("href"),title:this.attr("title"),delegateToServer:function(){window.location.pathname=a.attr("href")}}}),
e=b(function(){var a=this;return{method:this.attr("method"),fullPath:[this.attr("action"),function(a){return Davis.utils.map(a.serializeArray(),function(a){return[a.name,a.value].join("=")}).join("&")}(this)].join("?"),title:this.attr("title"),delegateToServer:function(){a.submit()}}});return{listen:function(){jQuery(document).delegate(this.settings.formSelector,"submit",e);jQuery(document).delegate(this.settings.linkSelector,"click",c)},unlisten:function(){jQuery(document).undelegate(this.settings.linkSelector,
"click",c);jQuery(document).undelegate(this.settings.formSelector,"submit",e)}}}();Davis.event={_callbacks:{},bind:function(a,b){this._callbacks[a]||(this._callbacks[a]=[]);this._callbacks[a].push(b);return this},trigger:function(a){var b=this,c=arguments;this._callbacks[a]||(this._callbacks[a]=[]);Davis.utils.forEach(this._callbacks[a],function(a){a.apply(b,Davis.utils.toArray(c,1))});return this}};
Davis.logger=function(){var a=function(a){a=Davis.utils.toArray(a);a.unshift("["+Date()+"]");return a.join(" ")};return{error:function(){window.console&&console.error(a(arguments))},info:function(){window.console&&console.info(a(arguments))},warn:function(){window.console&&console.warn(a(arguments))}}}();
Davis.Route=function(){var a=/:([\w\d]+)/g,b=function(c,b,d){this.paramNames=function(){for(var c=[],d;d=a.exec(b);)c.push(d[1]);return c}();this.path=function(){if(b instanceof RegExp)return b;else{var c=b.replace(a,"([^/]+)");b.lastIndex=0;return RegExp("^"+c+"$","gi")}}();this.method=c instanceof RegExp?c:RegExp("^"+c+"$","i");this.callback=d};b.prototype={match:function(a,b){this.reset();return this.method.test(a)&&this.path.test(b)},reset:function(){this.method.lastIndex=0;this.path.lastIndex=
0},run:function(a){this.reset();var b=this.path.exec(a.path);if(b){b.shift();for(var d=0;d<b.length;d++)a.params[this.paramNames[d]]=b[d]}return this.callback.call(a,a)},toString:function(){return[this.method,this.path].join(" ")}};return b}();
Davis.router=function(){var a=this;Davis.utils.forEach(["get","post","put"],function(b){a[b]=function(c,e){a._routeCollection.push(new Davis.Route(b,c,e))}});this.del=function(b,c){a._routeCollection.push(new Davis.Route("delete",b,c))};this.state=function(b,c){a._routeCollection.push(new Davis.Route("state",b,c))};this.trans=function(a,c){var e=c?[a,decodeURIComponent(jQuery.param(c))].join("?"):a;e=new Davis.Request({method:"state",fullPath:e,title:""});Davis.location.assign(e)};Davis.utils.forEach(["before",
"after"],function(b){a[b]=function(){if(arguments.length==1)var c=/.+/,d=arguments[0];else arguments.length==2&&(c=arguments[0],d=arguments[1]);a._filterCollection[b].push(new Davis.Route(/.+/,c,d))};var c="lookup"+b.replace(/^\w/,function(a){return a.toUpperCase()})+"Filter";a[c]=function(c,d){return Davis.utils.filter(a._filterCollection[b],function(a){return a.match(c,d)})}});a._routeCollection=[];a._filterCollection={before:[],after:[]};a.lookupRoute=function(a,c){return Davis.utils.filter(this._routeCollection,
function(e){return e.match(a,c)})[0]}};
Davis.history=function(){var a=[],b=!0,c=function(a){return function(c){c.state&&c.state._davis?a(new Davis.Request(c.state._davis)):b||a(Davis.Request.forPageLoad());b=!1}},e=function(a){return{_davis:a}};return{onChange:function(b){a.push(b);b=c(b);window.addEventListener("popstate",b,!0)},current:function(){return window.location.pathname},assign:function(c){history.pushState(e(c.asJSON()),c.title,c.location());Davis.utils.forEach(a,function(a){a(c)})},replace:function(c){history.replaceState(e(c.asJSON()),c.title,
c.location());Davis.utils.forEach(a,function(a){a(c)})}}}();Davis.location=function(){var a=Davis.history;return{setLocationDelegate:function(b){a=b},current:function(){return a.current()},assign:function(b){a.assign(b)},replace:function(b){a.replace(b)},onChange:function(b){a.onChange(b)}}}();
Davis.Request=function(a){a=jQuery.extend({},{title:"",fullPath:"",method:"get"},a);var b=this;this.raw=a;this.params={};this.title=a.title;this.queryString=a.fullPath.split("?")[1];this._staleCallback=function(){};this.queryString&&Davis.utils.forEach(this.queryString.split("&"),function(a){var e=a.split("=")[0];a=a.split("=")[1];var d;if(d=/^(\w+)\[(\w+)\](\[\])?/.exec(e)){var f=d[1];e=d[2];var g=b.params[f]||{};d[3]?(g[e]=g[e]||[],g[e].push(a)):g[e]=a;b.params[f]=g}else b.params[e]=a});a.fullPath=
a.fullPath.replace(/^https?:\/\/.+?\//,"/");this.method=(this.params._method||a.method).toLowerCase();this.path=a.fullPath.replace(/\?.+$/,"").replace(/^https?:\/\/[^\/]+/,"");this.delegateToServer=a.delegateToServer||Davis.noop;this.isForPageLoad=a.forPageLoad||!1;Davis.Request.prev&&Davis.Request.prev.makeStale(this);Davis.Request.prev=this};Davis.Request.prototype.redirect=function(a){Davis.location.replace(new Davis.Request({method:"get",fullPath:a,title:this.title}))};
Davis.Request.prototype.whenStale=function(a){this._staleCallback=a};Davis.Request.prototype.makeStale=function(a){this._staleCallback.call(a,a)};Davis.Request.prototype.location=function(){return this.method==="get"?this.path:""};Davis.Request.prototype.toString=function(){return[this.method.toUpperCase(),this.path].join(" ")};Davis.Request.prototype.asJSON=function(){return{title:this.raw.title,fullPath:this.raw.fullPath,method:this.raw.method}};
Davis.Request.forPageLoad=function(){return new this({method:"get",fullPath:Davis.location.current(),title:document.title,forPageLoad:!0})};Davis.Request.prev=null;
Davis.App=function(){var a=0,b=function(){this.id=[(new Date).valueOf(),a++].join("-");this.boundToInternalEvents=this.running=!1};b.prototype=jQuery.extend({configure:function(a){a.call(this.settings,this.settings)},use:function(a){a.apply(this,Davis.utils.toArray(arguments,1))},helpers:function(a){for(property in a)a.hasOwnProperty(property)&&(Davis.Request.prototype[property]=a[property])},settings:{linkSelector:"a",formSelector:"form",logger:Davis.logger,throwErrors:!0,handleRouteNotFound:!1,
generateRequestOnPageLoad:!0},start:function(){var a=this;if(Davis.supported()){var b=function(a){return function(b){b=b.run(a,a);return typeof b==="undefined"||b}},d=function(d){if(Davis.utils.every(a.lookupBeforeFilter(d.method,d.path),b(d))){a.trigger("lookupRoute",d);var f=a.lookupRoute(d.method,d.path);if(f){a.trigger("runRoute",d,f);try{f.run(d),a.trigger("routeComplete",d,f)}catch(h){a.trigger("routeError",d,f,h)}Davis.utils.every(a.lookupAfterFilter(d.method,d.path),b(d))}else a.trigger("routeNotFound",
d)}else a.trigger("requestHalted",d)},f;this.boundToInternalEvents||function(){a.bind("runRoute",function(b){a.settings.logger.info("runRoute: "+b.toString())}).bind("routeNotFound",function(b){!a.settings.handleRouteNotFound&&!b.isForPageLoad&&(a.stop(),b.delegateToServer());a.settings.logger.warn("routeNotFound: "+b.toString())}).bind("start",function(){a.settings.logger.info("application started")}).bind("stop",function(){a.settings.logger.info("application stopped")}).bind("routeError",function(b,
d,e){if(a.settings.throwErrors)throw e;a.settings.logger.error(e.message,e.stack)});Davis.location.onChange(function(a){d(a)});a.boundToInternalEvents=!0}();this.listen();this.trigger("start");this.running=!0;this.settings.generateRequestOnPageLoad&&d(Davis.Request.forPageLoad())}else this.trigger("unsupported")},stop:function(){this.unlisten();this.trigger("stop");this.running=!1}},Davis.listener,Davis.event);Davis.router.call(b.prototype);return b}();
