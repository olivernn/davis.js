// davis.js JavaScript Routing, version: 0.4.2
// (c) 2011 Oliver Nightingale
//
//  Released under MIT license.
//
Davis=function(a){var d=new Davis.App;a.call(d);return d};Davis.supported=function(){return typeof window.history.pushState=="function"};Davis.noop=function(){};
Davis.utils=function(){return{every:Array.prototype.every?function(a,d,b){return a.every(d,b)}:function(a,d,b){if(a===void 0||a===null)throw new TypeError;a=Object(a);var c=a.length>>>0;if(typeof d!=="function")throw new TypeError;for(var e=0;e<c;e++)if(e in a&&!d.call(b,a[e],e,a))return false;return true},forEach:Array.prototype.forEach?function(a,d,b){return a.forEach(d,b)}:function(a,d,b){if(a===void 0||a===null)throw new TypeError;a=Object(a);var c=a.length>>>0;if(typeof d!=="function")throw new TypeError;
for(var e=0;e<c;e++)e in a&&d.call(b,a[e],e,a)},filter:Array.prototype.filter?function(a,d,b){return a.filter(d,b)}:function(a,d,b){if(a===void 0||a===null)throw new TypeError;a=Object(a);var c=a.length>>>0;if(typeof d!=="function")throw new TypeError;for(var e=[],g=0;g<c;g++)if(g in a){var f=a[g];d.call(b,f,g,a)&&e.push(f)}return e},map:Array.prototype.map?function(a,d,b){return a.map(d,b)}:function(a,d,b){if(a===void 0||a===null)throw new TypeError;a=Object(a);var c=a.length>>>0;if(typeof d!=="function")throw new TypeError;
for(var e=Array(c),g=0;g<c;g++)if(g in a)e[g]=d.call(b,a[g],g,a);return e},toArray:function(a,d){return Array.prototype.slice.call(a,d||0)}}}();
Davis.listener=function(){var a=function(c){return function(){var e=new Davis.Request(c.call(jQuery(this)));Davis.history.pushState(e);return false}},d=a(function(){var c=this;return{method:"get",fullPath:this.attr("href"),title:this.attr("title"),delegateToServer:function(){window.location.pathname=c.attr("href")}}}),b=a(function(){var c=this;return{method:this.attr("method"),fullPath:[this.attr("action"),function(e){return Davis.utils.map(e.serializeArray(),function(g){return[g.name,g.value].join("=")}).join("&")}(this)].join("?"),
title:this.attr("title"),delegateToServer:function(){c.submit()}}});return{listen:function(){jQuery(document).delegate(this.settings.formSelector,"submit",b);jQuery(document).delegate(this.settings.linkSelector,"click",d)},unlisten:function(){jQuery(document).undelegate(this.settings.linkSelector,"click",d);jQuery(document).undelegate(this.settings.formSelector,"submit",b)}}}();
Davis.event={_callbacks:{},bind:function(a,d){this._callbacks[a]||(this._callbacks[a]=[]);this._callbacks[a].push(d);return this},trigger:function(a){var d=this,b=arguments;this._callbacks[a]||(this._callbacks[a]=[]);Davis.utils.forEach(this._callbacks[a],function(c){c.apply(d,Davis.utils.toArray(b,1))});return this}};
Davis.logger=function(){var a=function(d){d=Davis.utils.toArray(d);d.unshift("["+Date()+"]");return d};return{error:function(){window.console&&console.error.apply(console,a(arguments))},info:function(){window.console&&console.info.apply(console,a(arguments))},warn:function(){window.console&&console.warn.apply(console,a(arguments))}}}();
Davis.Route=function(){var a=/:([\w\d]+)/g,d=function(b,c,e){this.paramNames=function(){for(var f=[],h;h=a.exec(c);)f.push(h[1]);return f}();var g;g=c instanceof RegExp?c:RegExp("^"+c.replace(a,"([^/]+)")+"$","gi");this.path=g;this.method=b instanceof RegExp?b:RegExp("^"+b+"$","i");this.callback=e};d.prototype={match:function(b,c){this.reset();return this.method.test(b)&&this.path.test(c)},reset:function(){this.method.lastIndex=0;this.path.lastIndex=0},run:function(b){this.reset();var c=this.path.exec(b.path);
if(c){c.shift();for(var e=0;e<c.length;e++)b.params[this.paramNames[e]]=c[e]}return this.callback.call(b,b)},toString:function(){return[this.method,this.path].join(" ")}};return d}();
Davis.router=function(){var a=this;Davis.utils.forEach(["get","post","put"],function(d){a[d]=function(b,c){a._routeCollection.push(new Davis.Route(d,b,c))}});this.del=function(d,b){a._routeCollection.push(new Davis.Route("delete",d,b))};this.state=function(d,b){a._routeCollection.push(new Davis.Route("state",d,b))};this.trans=function(d,b){var c=b?[d,decodeURIComponent($.param(b))].join("?"):d;c=new Davis.Request({method:"state",fullPath:c,title:""});Davis.history.pushState(c)};Davis.utils.forEach(["before",
"after"],function(d){a[d]=function(){if(arguments.length==1)var c=/.+/,e=arguments[0];else if(arguments.length==2){c=arguments[0];e=arguments[1]}a._filterCollection[d].push(new Davis.Route(/.+/,c,e))};var b="lookup"+d.replace(/^\w/,function(c){return c.toUpperCase()})+"Filter";a[b]=function(c,e){return Davis.utils.filter(a._filterCollection[d],function(g){return g.match(c,e)})}});a._routeCollection=[];a._filterCollection={before:[],after:[]};a.lookupRoute=function(d,b){return Davis.utils.filter(this._routeCollection,
function(c){return c.match(d,b)})[0]}};
Davis.history=function(){var a=[],d=true,b=function(c){return function(e){if(e.state){e=e.state;e.__proto__=Davis.Request.prototype;c(e)}else d||c(Davis.Request.forPageLoad());d=false}};return{replaceState:function(c){history.replaceState(c,c.title,c.location());Davis.utils.forEach(a,function(e){e(c)})},pushState:function(c){history.pushState(c,c.title,c.location());Davis.utils.forEach(a,function(e){e(c)})},onChange:function(c){a.push(c);c=b(c);window.addEventListener("popstate",c,true)}}}();
Davis.Request=function(a){var d=this;this.params={};this.title=a.title;this.queryString=a.fullPath.split("?")[1];this._staleCallback=function(){};this.queryString&&Davis.utils.forEach(this.queryString.split("&"),function(b){var c=b.split("=")[0];b=b.split("=")[1];var e;if(e=/^(\w+)\[(\w+)\]/.exec(c)){var g=e[1];c=e[2];e=d.params[g]||{};e[c]=b;d.params[g]=e}else d.params[c]=b});this.method=(this.params._method||a.method).toLowerCase();this.path=a.fullPath.replace(/\?.+$/,"");this.delegateToServer=
a.delegateToServer||Davis.noop;this.isForPageLoad=a.forPageLoad||false;Davis.Request.prev&&Davis.Request.prev.makeStale(this);Davis.Request.prev=this};Davis.Request.prototype.redirect=function(a){Davis.history.replaceState(new Davis.Request({method:"get",fullPath:a,title:this.title}))};Davis.Request.prototype.whenStale=function(a){this._staleCallback=a};Davis.Request.prototype.makeStale=function(a){this._staleCallback.call(a,a)};
Davis.Request.prototype.location=function(){return this.method==="get"?this.path:""};Davis.Request.prototype.toString=function(){return[this.method.toUpperCase(),this.path].join(" ")};Davis.Request.forPageLoad=function(){return new this({method:"get",fullPath:window.location.pathname,title:document.title,forPageLoad:true})};Davis.Request.prev=null;
Davis.App=function(){var a=0,d=function(){this.id=[(new Date).valueOf(),a++].join("-");this.boundToInternalEvents=this.running=false};d.prototype=jQuery.extend({configure:function(b){b.call(this.settings)},use:function(b){b.apply(this,Davis.utils.toArray(arguments,1))},helpers:function(b){for(property in b)if(b.hasOwnProperty(property))Davis.Request.prototype[property]=b[property]},settings:{linkSelector:"a",formSelector:"form",logger:Davis.logger,throwErrors:true,handleRouteNotFound:false,generateRequestOnPageLoad:true},
start:function(){var b=this;if(Davis.supported()){var c=function(f){return function(h){h=h.run(f,f);return typeof h==="undefined"||h}},e=function(f){if(Davis.utils.every(b.lookupBeforeFilter(f.method,f.path),c(f))){b.trigger("lookupRoute",f);var h=b.lookupRoute(f.method,f.path);if(h){b.trigger("runRoute",f,h);try{h.run(f);b.trigger("routeComplete",f,h)}catch(i){b.trigger("routeError",f,h,i)}Davis.utils.every(b.lookupAfterFilter(f.method,f.path),c(f))}else b.trigger("routeNotFound",f)}else b.trigger("requestHalted",
f)},g;this.boundToInternalEvents||function(){b.bind("runRoute",function(f){b.settings.logger.info("runRoute: "+f.toString())}).bind("routeNotFound",function(f){if(!b.settings.handleRouteNotFound&&!f.isForPageLoad){b.stop();f.delegateToServer()}b.settings.logger.warn("routeNotFound: "+f.toString())}).bind("start",function(){b.settings.logger.info("application started")}).bind("stop",function(){b.settings.logger.info("application stopped")}).bind("routeError",function(f,h,i){if(b.settings.throwErrors)throw i;
b.settings.logger.error(i.message,i.stack)});Davis.history.onChange(function(f){e(f)});b.boundToInternalEvents=true}();this.listen();this.trigger("start");this.running=true;this.settings.generateRequestOnPageLoad&&e(Davis.Request.forPageLoad())}else this.trigger("unsupported")},stop:function(){this.unlisten();this.trigger("stop");this.running=false}},Davis.listener,Davis.event);Davis.router.call(d.prototype);return d}();
